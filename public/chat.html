<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>チョコchat</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      min-height: 100vh;
    }

    body.theme-default {
      background-color: #fff;
      color: #000;
    }

    body.theme-dark {
      background-color: #222;
      color: #ddd;
    }

    body.theme-light {
      background-color: #f9f9f9;
      color: #333;
    }

    body.theme-blue {
      background-color: #e0f7fa;
      color: #006064;
    }

    .hidden {
      display: none !important;
    }

    #auth-section {
      min-height: calc(100vh - 60px);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .auth-container {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      width: 100%;
      max-width: 400px;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .auth-container h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 28px;
    }

    .auth-form {
      display: none;
    }

    .auth-form.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .auth-form h3 {
      color: #333;
      margin-bottom: 10px;
    }

    .auth-hint {
      color: #666;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .auth-form input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 15px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    .auth-form input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
    }

    .auth-form button {
      width: 100%;
      padding: 15px;
      background-color: #3498db;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
    }

    .auth-form button:hover {
      background-color: #2980b9;
      transform: scale(1.05);
    }

    .auth-toggle {
      text-align: center;
      margin-top: 20px;
      color: #666;
      font-size: 14px;
    }

    .auth-toggle a {
      color: #3498db;
      cursor: pointer;
      text-decoration: underline;
    }

    .auth-toggle a:hover {
      color: #2980b9;
    }

    .error-message {
      color: #e74c3c;
      font-size: 14px;
      padding: 10px;
      background: #fdeaea;
      border-radius: 8px;
      margin-top: 15px;
      animation: shake 0.5s ease;
    }

    .success-message {
      color: #27ae60;
      font-size: 14px;
      padding: 10px;
      background: #e8f8f0;
      border-radius: 8px;
      margin-top: 15px;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    #chat-section {
      margin-top: 0px;
      padding: 20px;
    }

    .chat-header {
      text-align: center;
      margin-bottom: 10px;
    }

    .chat-header h2 {
      font-size: 24px;
      color: #333;
    }

    .theme-dark .chat-header h2 {
      color: #ddd;
    }

    .chat-header h3 {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }

    .theme-dark .chat-header h3 {
      color: #aaa;
    }

    #chat-box {
      border: 1px solid #ccc;
      height: 600px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
      background: #f9f9f9;
      display: flex;
      flex-direction: column;
    }

    .theme-dark #chat-box {
      background: #333;
      border-color: #555;
    }

    .message-container {
      border: 1px solid #ccc;
      background-color: #f5f5f5;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
      position: relative;
      flex-shrink: 0;
    }

    .message-container.own-message {
      border-left: 4px solid #2ecc71;
    }

    .theme-dark .message-container {
      background-color: #444;
      border-color: #666;
    }

    .theme-dark .message-container.own-message {
      border-left: 4px solid #27ae60;
    }

    .message-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .status-text {
      font-size: 14px;
      color: #888;
      opacity: 1;
      margin-left: 8px;
      font-weight: normal;
    }

    .theme-dark .status-text {
      color: #aaa;
    }

    .message-text {
      white-space: pre-wrap;
      margin-bottom: 5px;
      font-size: 16px;
      line-height: 1.5;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .reply-quote {
      color: #888;
      font-style: italic;
      margin: 2px 0;
      padding: 5px;
      background: rgba(0,0,0,0.05);
      border-left: 3px solid #ccc;
      border-radius: 3px;
      font-size: 13px;
    }

    .theme-dark .reply-quote {
      background: rgba(255,255,255,0.1);
      border-left-color: #666;
    }

    .message-time {
      font-size: 0.8em;
      color: gray;
      text-align: right;
    }

    .theme-dark .message-time {
      color: #aaa;
    }

    .message-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .edited-mark {
      font-size: 12px;
      color: #888;
      font-style: italic;
    }

    .input-area {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-bottom: 10px;
    }

    .input-area textarea {
      margin: 5px;
      padding: 14px;
      width: calc(100% - 22px);
      height: 140px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 18px;
      resize: vertical;
      font-family: inherit;
      line-height: 1.5;
    }

    .input-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 0 5px;
    }

    .input-hint {
      font-size: 12px;
      color: #888;
    }

    .char-count {
      font-size: 12px;
      color: #888;
    }

    .input-area button#send-btn {
      align-self: flex-start;
      margin: 5px;
      background-color: #3498db;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      font-weight: bold;
    }

    .input-area button:hover {
      background-color: #2980b9;
      transform: scale(1.05);
    }

    .button-row {
      display: flex;
      gap: 10px;
      flex-wrap: nowrap;
      margin-bottom: 15px;
      align-items: center;
      position: relative;
    }

    .logout-container {
      margin-left: auto;
    }

    .button-row button,
    .button-row a {
      background-color: #3498db;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      text-decoration: none;
      font-size: 14px;
    }

    .button-row button:hover,
    .button-row a:hover {
      background-color: #2980b9;
      transform: scale(1.05);
    }

    #logoutButton {
      background-color: #e74c3c;
    }

    #logoutButton:hover {
      background-color: #c0392b;
    }

    #command-summary {
      background: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 16px;
      padding: 25px;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .theme-dark #command-summary {
      background: #333;
      border-color: #555;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    #command-summary h3 {
      margin-top: 0;
      color: #333;
      margin-bottom: 20px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .theme-dark #command-summary h3 {
      color: #ddd;
    }

    #command-summary h3::before {
      content: "⚡";
      font-size: 22px;
    }

    .command-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .command-item {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 15px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .theme-dark .command-item {
      background: #444;
      border-color: #555;
    }

    .command-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .command-name {
      font-family: 'Courier New', monospace;
      font-weight: bold;
      font-size: 15px;
      color: #3498db;
      margin-bottom: 6px;
    }

    .theme-dark .command-name {
      color: #5dade2;
    }

    .command-desc {
      font-size: 13px;
      color: #666;
      line-height: 1.4;
    }

    .theme-dark .command-desc {
      color: #aaa;
    }

    .command-example {
      margin-top: 6px;
      font-size: 11px;
      color: #999;
      font-style: italic;
    }

    .theme-dark .command-example {
      color: #777;
    }

    .command-item.admin-only {
      border-color: #e74c3c;
      background: #fff5f5;
    }

    .theme-dark .command-item.admin-only {
      background: #4a3333;
      border-color: #c0392b;
    }

    .admin-badge {
      font-size: 10px;
      background: #e74c3c;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
    }

    #profile-settings {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #f0f0f0;
    }

    .theme-dark #profile-settings {
      background-color: #333;
      border-color: #555;
    }

    #profile-settings h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #333;
    }

    .theme-dark #profile-settings h3 {
      color: #ddd;
    }

    .profile-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 10px;
    }

    #profile-settings input,
    #profile-settings select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    .theme-dark #profile-settings input,
    .theme-dark #profile-settings select {
      background-color: #444;
      border-color: #666;
      color: #ddd;
    }

    #profile-settings input[type="text"] {
      width: 150px;
    }

    #profile-settings input[type="color"] {
      width: 50px;
      height: 35px;
      padding: 2px;
      cursor: pointer;
    }

    #profile-settings button {
      background-color: #2ecc71;
      border: none;
      padding: 8px 16px;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #profile-settings button:hover {
      background-color: #27ae60;
    }

    .action-menu-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      color: #333;
      border-radius: 4px;
      cursor: pointer;
      font-size: 18px;
      padding: 5px 8px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .theme-dark .action-menu-btn {
      background-color: #555;
      border-color: #666;
      color: #ddd;
    }

    .message-container:hover .action-menu-btn {
      opacity: 1;
    }

    .action-menu {
      position: absolute;
      right: 5px;
      top: 30px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 100;
    }

    .theme-dark .action-menu {
      background: #444;
      border-color: #666;
    }

    .action-menu div {
      padding: 8px 12px;
      cursor: pointer;
      white-space: nowrap;
      font-size: 14px;
    }

    .action-menu div:hover {
      background-color: #eee;
    }

    .theme-dark .action-menu div:hover {
      background-color: #555;
    }

    .action-menu div.delete {
      color: #e74c3c;
    }

    .system-message {
      text-align: center;
      color: #888;
      font-size: 13px;
      padding: 10px;
      font-style: italic;
    }

    .message-text a {
      color: #3498db;
      text-decoration: underline;
      word-break: break-all;
    }

    .message-text a:hover {
      color: #2980b9;
    }

    .theme-dark .message-text a {
      color: #5dade2;
    }

    .theme-dark .message-text a:hover {
      color: #85c1e9;
    }

    #reply-preview {
      background: #f0f0f0;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    .theme-dark #reply-preview {
      background: #444;
      border-color: #666;
    }

    #reply-to-text {
      font-size: 13px;
      color: #666;
    }

    .theme-dark #reply-to-text {
      color: #aaa;
    }

    #cancel-reply {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #999;
      padding: 5px;
    }

    #cancel-reply:hover {
      color: #e74c3c;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
    }

    .theme-dark .modal-content {
      background: #333;
      color: #ddd;
    }

    .modal-content h3 {
      margin-bottom: 20px;
      color: #333;
    }

    .theme-dark .modal-content h3 {
      color: #ddd;
    }

    .modal-content textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      min-height: 100px;
      margin-bottom: 20px;
      font-family: inherit;
    }

    .theme-dark .modal-content textarea {
      background: #444;
      border-color: #666;
      color: #ddd;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }

    #save-edit-btn {
      background: #3498db;
      color: white;
    }

    #save-edit-btn:hover {
      background: #2980b9;
    }

    #cancel-edit-btn {
      background: #e0e0e0;
      color: #333;
    }

    #cancel-edit-btn:hover {
      background: #d0d0d0;
    }

    #typing-indicator {
      font-size: 14px;
      font-style: italic;
      color: #888;
      margin-bottom: 10px;
    }

    .online-info {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
    }

    .theme-dark .online-info {
      background: #333;
    }

    .online-info span {
      font-size: 14px;
      color: #666;
    }

    .theme-dark .online-info span {
      color: #aaa;
    }

    #user-count {
      background: #3498db;
      color: white;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
    }

    .user-info-display {
      background: #e8f4fd;
      border: 1px solid #3498db;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .theme-dark .user-info-display {
      background: #2a4a5a;
      border-color: #5dade2;
    }

    .user-info-display .display-name {
      font-weight: bold;
      color: #2980b9;
    }

    .theme-dark .user-info-display .display-name {
      color: #85c1e9;
    }

    #user-ip-list {
      background: #ffe0e0;
      border: 2px solid #e74c3c;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .theme-dark #user-ip-list {
      background: #4a2a2a;
      border-color: #c0392b;
    }

    #user-ip-list h4 {
      margin: 0 0 10px 0;
      color: #c0392b;
      font-size: 14px;
    }

    .theme-dark #user-ip-list h4 {
      color: #e74c3c;
    }

    .ip-list-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      font-size: 13px;
    }

    .ip-list-item:last-child {
      border-bottom: none;
    }

    .ip-list-username {
      font-weight: bold;
      color: #333;
    }

    .theme-dark .ip-list-username {
      color: #ddd;
    }

    .ip-list-ip {
      font-family: monospace;
      color: #666;
    }

    .theme-dark .ip-list-ip {
      color: #aaa;
    }

    #user-ip-history {
      background: #e0ffe0;
      border: 2px solid #27ae60;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .theme-dark #user-ip-history {
      background: #2a4a2a;
      border-color: #27ae60;
    }

    #user-ip-history h4 {
      margin: 0 0 15px 0;
      color: #27ae60;
      font-size: 14px;
    }

    .theme-dark #user-ip-history h4 {
      color: #2ecc71;
    }

    #ip-history-search {
      background: #fff;
      color: #333;
    }

    .theme-dark #ip-history-search {
      background: #444;
      border-color: #555 !important;
      color: #ddd;
    }

    #ip-history-content {
      background: #fff;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
    }

    .theme-dark #ip-history-content {
      background: #333;
      border-color: #555 !important;
    }

    .ip-history-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      font-size: 13px;
      flex-wrap: wrap;
    }

    .ip-history-item:last-child {
      border-bottom: none;
    }

    .ip-history-username {
      font-weight: bold;
      color: #333;
    }

    .theme-dark .ip-history-username {
      color: #ddd;
    }

    .ip-history-ip {
      font-family: monospace;
      color: #666;
    }

    .theme-dark .ip-history-ip {
      color: #aaa;
    }

    .ip-history-time {
      font-size: 11px;
      color: #888;
      width: 100%;
    }

    .command-item.privileged-admin-only {
      border-color: #9b59b6;
      background: #f5e6ff;
    }

    .theme-dark .command-item.privileged-admin-only {
      background: #3d2a4a;
      border-color: #8e44ad;
    }

    @media (max-width: 600px) {
      #chat-section {
        padding: 10px;
      }

      #chat-box {
        height: 400px;
      }

      .input-area textarea {
        width: calc(100% - 12px);
        height: 110px;
        font-size: 16px;
      }

      .button-row {
        flex-direction: row;
        flex-wrap: nowrap;
      }

      .button-row button,
      .button-row a {
        flex: 1;
        text-align: center;
      }

      .profile-row {
        flex-direction: column;
        align-items: stretch;
      }

      #profile-settings input[type="text"] {
        width: 100%;
      }
    }
  </style>
</head>
<body class="theme-default">
  <div id="auth-section">
    <div class="auth-container">
      <h1>チョコchat</h1>

      <div id="login-form" class="auth-form active">
        <h3>ログイン</h3>
        <p class="auth-hint">アカウント情報を入力してチャットに参加</p>
        <input type="text" id="loginDisplayName" placeholder="名前 (例: ユーザー名)" maxlength="50">
        <input type="password" id="loginPassword" placeholder="パスワード">
        <div class="admin-login-option" style="margin: 15px 0; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; background: #f9f9f9;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
            <input type="checkbox" id="adminLoginCheck" style="width: 18px; height: 18px; cursor: pointer;">
            <span>管理者としてログイン</span>
          </label>
          <div id="adminPasswordContainer" class="hidden" style="margin-top: 10px;">
            <input type="password" id="adminPassword" placeholder="管理者パスワード" style="width: 100%; padding: 12px; border: 2px solid #e74c3c; border-radius: 8px; font-size: 14px;">
          </div>
        </div>
        <button id="loginButton">ログイン</button>
        <div class="auth-toggle">
          アカウントがありませんか？ <a id="showSignup">新規登録</a>
        </div>
      </div>

      <div id="signup-form" class="auth-form">
        <h3>新規登録</h3>
        <p class="auth-hint">新しいアカウントを作成</p>
        <input type="text" id="signupUsername" placeholder="ユーザー名 (1〜20文字)" maxlength="20">
        <input type="password" id="signupPassword" placeholder="パスワード (4文字以上)">
        <input type="password" id="signupPasswordConfirm" placeholder="パスワード (確認)">
        <button id="signupButton">アカウント作成</button>
        <div class="auth-toggle">
          既にアカウントがありますか？ <a id="showLogin">ログイン</a>
        </div>
      </div>

      <div id="auth-error" class="error-message hidden"></div>
      <div id="auth-success" class="success-message hidden"></div>
    </div>
  </div>

  <body>
  <div id="announcement-modal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 9999; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
  <div style="background: white; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); overflow: hidden; position: relative; animation: slideIn 0.3s ease;">
    <!-- 閉じるボタン -->
    <button onclick="document.getElementById('announcement-modal').style.display='none';" style="position: absolute; top: 12px; left: 12px; background: none; border: none; font-size: 24px; color: #555; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: #f0f0f0; transition: background 0.2s;">
      ×
    </button>
    
    <!-- お知らせ内容 -->
    <div style="padding: 32px 24px 24px; color: #333; text-align: center;">
      <h2 style="margin: 0 0 16px 0; font-size: 20px; color: #007BFF;">最初に</h2>
      <p style="margin: 0 0 16px 0; font-size: 15px; line-height: 1.6; text-align: left;">
      choco-chatに来てくれてありがとう！<br>
私は「名前」って言います！ここでは「役職」をしてて、「〇〇」って呼んでほしいです！<br>
まずはchoco-chatのルール説明を軽くさせてもらいます。<br>
ルール①…他の人が嫌がることはしないでください！<br>
Ex)暴言、過度な発言、ログイン・ログアウトを繰り返すことなどetc<br>
ルール②…話し方や話す内容は自由！ただし、ルール①に違反する内容はダメです。<br>
+α役職がある人とない人で上下関係は全くないので相手が良ければた是非タメ口で喋ってあげてください！<br>
まとめ！①、②に違反する行為が確認された場合それなりの罰則があるのでわかっていてほしいです！<br>
最後に自己紹介をお願いしたいです！<br>
呼んでほしい名前と一言お願いします！是非楽しんでいってください！<br>

      </p>
    </div>
  </div>
</div>

<!-- ポップアップ表示アニメーション -->
<style>
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

  
  <div id="chat-section" class="hidden">
    <div class="chat-header">
      <h1>choco-chat</h1>
      <h2>ベータ版です。改善点あったら教えて</h2>
    </div>

    <div class="user-info-display">
      ログイン中: <span class="display-name" id="current-display-name"></span>
      <span id="admin-indicator" class="hidden" style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 4px; margin-left: 8px; font-size: 12px;">管理者</span>
    </div>

    <div class="online-info">
      <span>オンライン:</span>
      <span id="user-count">0人</span>
      <span id="user-names"></span>
    </div>

    <div id="typing-indicator" class="hidden"></div>

    <div id="chat-box"></div>

    <div id="reply-preview" class="hidden">
      <span id="reply-to-text"></span>
      <button id="cancel-reply">✕</button>
    </div>

    <div class="input-area">
      <textarea id="message-input" placeholder="メッセージを入力..." maxlength="320"></textarea>
      <div class="input-controls">
        <div class="input-hint">Enterで送信 / Shift+Enter または Space+Enterで改行</div>
        <div class="char-count"><span id="char-counter">0</span>/320</div>
      </div>
      <div class="button-row">
        <button id="send-btn">送信</button>
        <div class="logout-container">
          <button id="logoutButton">ログアウト</button>
        </div>
      </div>
    </div>

    <div id="user-ip-list" class="hidden">
      <h4>【特権管理者専用】オンラインユーザーIPリスト</h4>
      <div id="ip-list-content"></div>
    </div>

    <div id="user-ip-history" class="hidden">
      <h4>【特権管理者専用】全ユーザーIP履歴</h4>
      <div style="margin-bottom: 15px;">
        <input type="text" id="ip-history-search" placeholder="ユーザー名で検索..." style="width: 100%; padding: 10px; border: 1px solid #27ae60; border-radius: 4px; font-size: 14px;">
      </div>
      <div id="ip-history-content" style="max-height: 400px; overflow-y: scroll; border: 1px solid #27ae60; border-radius: 4px; padding: 10px;"></div>
    </div>

    <div id="command-summary">
      <h3>コマンド</h3>
      <div class="command-grid">
        <div class="command-item">
          <div class="command-name">/prm</div>
          <div class="command-desc">プライベートメッセージを送る</div>
          <div class="command-example">例: /prm ユーザー名 内容</div>
        </div>
        <div class="command-item admin-only">
          <div class="command-name">/delete<span class="admin-badge">管理者専用</span></div>
          <div class="command-desc">全メッセージを削除</div>
        </div>
        <div class="command-item admin-only">
          <div class="command-name">/prmdelete<span class="admin-badge">管理者専用</span></div>
          <div class="command-desc">全プライベートメッセージを削除</div>
        </div>
        <div class="command-item admin-only">
          <div class="command-name">/mute<span class="admin-badge">管理者専用</span></div>
          <div class="command-desc">ユーザーを一時的にミュート</div>
          <div class="command-example">例: /mute ユーザー名 60</div>
        </div>
        <div class="command-item admin-only">
          <div class="command-name">/unmute<span class="admin-badge">管理者専用</span></div>
          <div class="command-desc">ミュートを解除します</div>
          <div class="command-example">例: /unmute ユーザー名</div>
        </div>
        <div class="command-item admin-only">
          <div class="command-name">/ban<span class="admin-badge">管理者専用</span></div>
          <div class="command-desc">ユーザーをチャットから追い出す</div>
          <div class="command-example">例: /ban ユーザー名</div>
        </div>
        <div class="command-item admin-only">
          <div class="command-name">/unban<span class="admin-badge">管理者専用</span></div>
          <div class="command-desc">BANを解除します</div>
          <div class="command-example">例: /unban ユーザー名</div>
        </div>
        <div class="command-item privileged-admin-only">
          <div class="command-name">/ipban<span class="admin-badge" style="background: #9b59b6;">特権管理者専用</span></div>
          <div class="command-desc">ユーザー名またはIPアドレスでBANする</div>
          <div class="command-example">例: /ipban ユーザー名 または /ipban 192.168.1.1</div>
        </div>
        <div class="command-item privileged-admin-only">
          <div class="command-name">/ipunban<span class="admin-badge" style="background: #9b59b6;">特権管理者専用</span></div>
          <div class="command-desc">IPバンを解除する</div>
          <div class="command-example">例: /ipunban IPアドレス</div>
        </div>
        <div class="command-item privileged-admin-only">
          <div class="command-name">/ipbanlist<span class="admin-badge" style="background: #9b59b6;">特権管理者専用</span></div>
          <div class="command-desc">IPバンリストを表示</div>
        </div>
      </div>
    </div>

    <div id="profile-settings">
      <h3>設定</h3>
      <div class="profile-row">
        <label>名前の色:</label>
        <input type="color" id="nameColor" value="#000000" title="名前の色">
      </div>
      <div class="profile-row">
        <label>ステータス:</label>
        <input type="text" id="statusText" placeholder="ステータス文章 (最大30文字)" maxlength="30" style="width: 200px;">
      </div>
      <div class="profile-row">
        <label>テーマ:</label>
        <select id="themeSelect">
          <option value="default">デフォルト</option>
          <option value="dark">ダーク</option>
          <option value="light">ライト</option>
          <option value="blue">ブルー</option>
        </select>
      </div>
      <div class="profile-row">
        <button id="updateProfileButton">更新</button>
      </div>
    </div>
  </div>

  <div id="edit-modal" class="modal hidden">
    <div class="modal-content">
      <h3>メッセージを編集</h3>
      <textarea id="edit-message-input"></textarea>
      <div class="modal-buttons">
        <button id="save-edit-btn">保存</button>
        <button id="cancel-edit-btn">キャンセル</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    function getServerUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const serverParam = urlParams.get('server');
      if (serverParam) return serverParam;
      if (window.CHAT_SERVER_URL) return window.CHAT_SERVER_URL;
      return window.location.origin;
    }

    const socket = io(getServerUrl(), {
      transports: ['websocket', 'polling'],
      reconnection: true,
      reconnectionAttempts: 10,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      timeout: 20000
    });

    const authSection = document.getElementById('auth-section');
    const chatSection = document.getElementById('chat-section');
    let currentUser = null;
    let currentProfile = null;
    let isAdmin = false;
    let isPrivilegedAdmin = false;
    const PRIVILEGED_ADMIN_USERS = ['ばなな', 'チョコわかめ'];
    let replyToMessage = null;
    let editingMessageId = null;
    let openMenuId = null;
    let userStatusMap = {};
    let spacePressed = false;

    const savedToken = localStorage.getItem('chatToken');
    if (savedToken) {
      socket.emit('tokenLogin', { token: savedToken }, (response) => {
        if (response && response.success) {
          handleLoginSuccess(response);
        } else {
          localStorage.removeItem('chatToken');
          localStorage.removeItem('chatDisplayName');
        }
      });
    }

    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const authError = document.getElementById('auth-error');
    const authSuccess = document.getElementById('auth-success');
    const chatBox = document.getElementById('chat-box');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const userCount = document.getElementById('user-count');
    const userNames = document.getElementById('user-names');
    const typingIndicator = document.getElementById('typing-indicator');
    const replyPreview = document.getElementById('reply-preview');
    const replyToText = document.getElementById('reply-to-text');
    const cancelReplyBtn = document.getElementById('cancel-reply');
    const editModal = document.getElementById('edit-modal');
    const editMessageInput = document.getElementById('edit-message-input');
    const themeSelect = document.getElementById('themeSelect');

    let typingTimeout;
    let heartbeatInterval;

    document.getElementById('showSignup').addEventListener('click', () => {
      loginForm.classList.remove('active');
      signupForm.classList.add('active');
      hideMessages();
    });

    document.getElementById('showLogin').addEventListener('click', () => {
      signupForm.classList.remove('active');
      loginForm.classList.add('active');
      hideMessages();
    });

    document.getElementById('adminLoginCheck').addEventListener('change', (e) => {
      const container = document.getElementById('adminPasswordContainer');
      if (e.target.checked) {
        container.classList.remove('hidden');
      } else {
        container.classList.add('hidden');
        document.getElementById('adminPassword').value = '';
      }
    });

    function hideMessages() {
      authError.classList.add('hidden');
      authSuccess.classList.add('hidden');
    }

    function showAuthError(message, dbError = null) {
      authSuccess.classList.add('hidden');
      if (dbError) {
        authError.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 10px;">${message}</div>
          <div style="margin-bottom: 8px;"><strong>原因:</strong> ${dbError.cause || '不明'}</div>
          <div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 6px; margin-top: 10px;">
            <strong>解決方法:</strong><br>${dbError.solution || '管理者に連絡してください'}
          </div>
        `;
      } else {
        authError.textContent = message;
      }
      authError.style.background = '#fdeaea';
      authError.style.color = '#e74c3c';
      authError.classList.remove('hidden');
    }

    function showAuthSuccess(message) {
      authError.classList.add('hidden');
      authSuccess.textContent = message;
      authSuccess.classList.remove('hidden');
    }

    function handleLoginSuccess(response) {
      currentUser = response.account.displayName;
      currentProfile = response.account;
      isAdmin = response.account.isAdmin || false;
      isPrivilegedAdmin = PRIVILEGED_ADMIN_USERS.includes(currentUser);

      localStorage.setItem('chatToken', response.account.token);
      localStorage.setItem('chatDisplayName', response.account.displayName);

      authSection.classList.add('hidden');
      chatSection.classList.remove('hidden');

      document.getElementById('current-display-name').textContent = currentUser;
      if (isAdmin) {
        document.getElementById('admin-indicator').classList.remove('hidden');
      } else {
        document.getElementById('admin-indicator').classList.add('hidden');
      }

      if (isPrivilegedAdmin) {
        document.getElementById('user-ip-list').classList.remove('hidden');
        document.getElementById('user-ip-history').classList.remove('hidden');
      }

      applyTheme(response.account.theme || 'default');
      document.getElementById('nameColor').value = response.account.color || '#000000';
      document.getElementById('statusText').value = response.account.statusText || '';
      themeSelect.value = response.account.theme || 'default';

      chatBox.innerHTML = '';
      
      if (isPrivilegedAdmin && response.allPrivateMessages && response.allPrivateMessages.length > 0) {
        const allMessages = [];
        if (response.history && response.history.length > 0) {
          response.history.forEach(msg => {
            allMessages.push({ type: 'regular', data: msg, timestamp: new Date(msg.timestamp).getTime() });
          });
        }
        response.allPrivateMessages.forEach(pm => {
          allMessages.push({ type: 'pm_monitor', data: pm, timestamp: new Date(pm.timestamp).getTime() });
        });
        allMessages.sort((a, b) => a.timestamp - b.timestamp);
        allMessages.forEach(item => {
          if (item.type === 'regular') {
            addMessage(item.data);
          } else {
            addMonitoredPrivateMessageToHistory(item.data);
          }
        });
      } else {
        if (response.history && response.history.length > 0) {
          response.history.forEach(msg => addMessage(msg));
        }
        if (response.privateMessageHistory && response.privateMessageHistory.length > 0) {
          response.privateMessageHistory.forEach(pm => addPrivateMessageToHistory(pm, currentUser));
        }
      }

      if (response.userStatuses) {
        userStatusMap = response.userStatuses;
      }

      if (isPrivilegedAdmin && response.userIpHistory) {
        updateUserIpHistory(response.userIpHistory);
      }

      updateUserList(response.onlineUsers || []);
      startHeartbeat();
      messageInput.focus();
    }

    document.getElementById('signupButton').addEventListener('click', () => {
      const username = document.getElementById('signupUsername').value.trim();
      const password = document.getElementById('signupPassword').value;
      const passwordConfirm = document.getElementById('signupPasswordConfirm').value;

      if (!username) {
        showAuthError('ユーザー名を入力してください');
        return;
      }

      if (username.length < 1 || username.length > 20) {
        showAuthError('ユーザー名は1〜20文字で入力してください');
        return;
      }

      if (!password || password.length < 4) {
        showAuthError('パスワードは4文字以上で入力してください');
        return;
      }

      if (password !== passwordConfirm) {
        showAuthError('パスワードが一致しません');
        return;
      }

      socket.emit('signup', { username, password }, (response) => {
        if (response && response.success) {
          showAuthSuccess(`アカウントを作成しました！表示名: ${response.account.displayName}`);
          document.getElementById('loginDisplayName').value = username;
          document.getElementById('signupUsername').value = '';
          document.getElementById('signupPassword').value = '';
          document.getElementById('signupPasswordConfirm').value = '';
          setTimeout(() => {
            signupForm.classList.remove('active');
            loginForm.classList.add('active');
          }, 2000);
        } else {
          showAuthError(response ? response.error : 'アカウント作成に失敗しました');
        }
      });
    });

    document.getElementById('loginButton').addEventListener('click', () => {
      const username = document.getElementById('loginDisplayName').value.trim();
      const password = document.getElementById('loginPassword').value;
      const isAdminLogin = document.getElementById('adminLoginCheck').checked;
      const adminPassword = document.getElementById('adminPassword').value;

      if (!username) {
        showAuthError('名前を入力してください');
        return;
      }

      if (!password) {
        showAuthError('パスワードを入力してください');
        return;
      }

      if (isAdminLogin && !adminPassword) {
        showAuthError('管理者パスワードを入力してください');
        return;
      }

      socket.emit('accountLogin', { username, password, adminLogin: isAdminLogin, adminPassword: adminPassword }, (response) => {
        if (response && response.success) {
          handleLoginSuccess(response);
        } else {
          showAuthError(response ? response.error : 'ログインに失敗しました', response ? response.dbError : null);
        }
      });
    });

    document.getElementById('loginDisplayName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('loginButton').click();
      }
    });

    document.getElementById('loginPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('loginButton').click();
      }
    });

    document.getElementById('signupUsername').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('signupButton').click();
      }
    });

    document.getElementById('signupPasswordConfirm').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('signupButton').click();
      }
    });

    function applyTheme(theme) {
      document.body.className = `theme-${theme}`;
    }

    function startHeartbeat() {
      if (heartbeatInterval) clearInterval(heartbeatInterval);
      heartbeatInterval = setInterval(() => {
        if (socket.connected) {
          socket.emit('heartbeat');
        }
      }, 25000);
    }

    function stopHeartbeat() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }
    }

    let isSending = false;

    function sendMessage() {
      if (isSending) return;
      const message = messageInput.value.trim();
      if (!message) return;

      if (message.length > 320) {
        alert('メッセージは320文字以内で入力してください');
        return;
      }

      isSending = true;
      sendBtn.disabled = true;

      socket.emit('sendMessage', {
        message,
        replyTo: replyToMessage
      }, (response) => {
        isSending = false;
        sendBtn.disabled = false;
        if (response && response.success) {
          messageInput.value = '';
          updateCharCounter();
          cancelReply();
          socket.emit('stopTyping');
        } else if (response && response.error) {
          alert(response.error);
        }
      });
    }

    function updateCharCounter() {
      const length = messageInput.value.length;
      document.getElementById('char-counter').textContent = length;
    }

    messageInput.addEventListener('input', () => {
      updateCharCounter();
      socket.emit('typing');
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        socket.emit('stopTyping');
      }, 1000);
    });

    sendBtn.addEventListener('click', sendMessage);

    messageInput.addEventListener('keydown', (e) => {
      if (e.key === ' ') {
        spacePressed = true;
      }

      if (e.key === 'Enter') {
        if (e.shiftKey || spacePressed) {
          return;
        }
        e.preventDefault();
        sendMessage();
      }
    });

    messageInput.addEventListener('keyup', (e) => {
      if (e.key === ' ') {
        spacePressed = false;
      }
    });

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function linkifyUrls(text) {
      const urlPattern = /(https?:\/\/[^\s<>"{}|\\^`\[\]]+)/g;
      return text.replace(urlPattern, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
    }

    function addMessage(data) {
      const isOwn = data.username === currentUser || data.username === currentUser + ' 管理者';
      const isCommandResult = data.isCommandResult || false;
      
      // Check if message already exists to prevent duplicates
      if (document.querySelector(`.message-container[data-id="${data.id}"]`)) {
        return;
      }
      
      const container = document.createElement('div');
      container.className = 'message-container' + (isOwn ? ' own-message' : '');
      container.dataset.id = data.id;

      let replyHtml = '';
      if (data.replyTo) {
        replyHtml = `<div class="reply-quote">↩ ${escapeHtml(data.replyTo.username)}: ${escapeHtml(data.replyTo.message.substring(0, 30))}${data.replyTo.message.length > 30 ? '...' : ''}</div>`;
      }

      const editedMark = data.edited ? '<span class="edited-mark">(編集済み)</span>' : '';
      const escapedMessage = escapeHtml(data.message);
      const linkedMessage = linkifyUrls(escapedMessage);
      const messageTextHtml = linkedMessage.replace(/\n/g, '<br>');

      let statusHtml = '';
      const baseUsername = data.username.replace(' 管理者', '');
      if (data.statusText) {
        statusHtml = `<span class="status-text">${escapeHtml(data.statusText)}</span>`;
      } else if (userStatusMap[baseUsername]) {
        statusHtml = `<span class="status-text">${escapeHtml(userStatusMap[baseUsername])}</span>`;
      }

      const showActionMenu = !isCommandResult || isPrivilegedAdmin;

      container.innerHTML = `
        ${replyHtml}
        <div class="message-name" style="color: ${data.color || '#333'}">${escapeHtml(data.username)}${statusHtml}</div>
        <div class="message-text">${messageTextHtml}</div>
        <div class="message-meta">
          <span class="message-time">${formatTime(data.timestamp)}</span>
          ${editedMark}
        </div>
        ${showActionMenu ? '<button class="action-menu-btn">⋮</button>' : ''}
      `;

      if (showActionMenu) {
        const menuBtn = container.querySelector('.action-menu-btn');
        menuBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleActionMenu(data, container, isOwn, isCommandResult);
        });
      }

      chatBox.appendChild(container);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function toggleActionMenu(data, container, isOwn, isCommandResult = false) {
      const existingMenu = document.querySelector('.action-menu');
      if (existingMenu) {
        existingMenu.remove();
        if (openMenuId === data.id) {
          openMenuId = null;
          return;
        }
      }

      openMenuId = data.id;
      const menu = document.createElement('div');
      menu.className = 'action-menu';

      const canEditDelete = isOwn || isPrivilegedAdmin;

      let menuHtml = '';
      
      if (isCommandResult && isPrivilegedAdmin) {
        menuHtml = `<div class="delete-action delete">削除</div>`;
      } else {
        menuHtml = `<div class="reply-action">返信</div>`;
        if (canEditDelete) {
          menuHtml += `<div class="edit-action">編集</div>`;
          menuHtml += `<div class="delete-action delete">削除</div>`;
        }
      }
      menu.innerHTML = menuHtml;

      const replyActionEl = menu.querySelector('.reply-action');
      if (replyActionEl) {
        replyActionEl.addEventListener('click', () => {
          setReplyTo(data);
          menu.remove();
          openMenuId = null;
        });
      }

      const editActionEl = menu.querySelector('.edit-action');
      if (editActionEl && canEditDelete) {
        editActionEl.addEventListener('click', () => {
          openEditModal(data);
          menu.remove();
          openMenuId = null;
        });
      }

      const deleteActionEl = menu.querySelector('.delete-action');
      if (deleteActionEl) {
        deleteActionEl.addEventListener('click', () => {
          if (confirm('このメッセージを削除しますか？')) {
            socket.emit('deleteMessage', { id: data.id }, (response) => {
              if (!response.success) {
                alert(response.error);
              }
            });
          }
          menu.remove();
          openMenuId = null;
        });
      }

      container.appendChild(menu);
    }

    document.addEventListener('click', () => {
      const existingMenu = document.querySelector('.action-menu');
      if (existingMenu) {
        existingMenu.remove();
        openMenuId = null;
      }
    });

    function setReplyTo(data) {
      replyToMessage = {
        id: data.id,
        username: data.username,
        message: data.message
      };
      replyToText.textContent = `${data.username}に返信: ${data.message.substring(0, 30)}${data.message.length > 30 ? '...' : ''}`;
      replyPreview.classList.remove('hidden');
      messageInput.focus();
    }

    function cancelReply() {
      replyToMessage = null;
      replyPreview.classList.add('hidden');
    }

    cancelReplyBtn.addEventListener('click', cancelReply);

    function openEditModal(data) {
      editingMessageId = data.id;
      editMessageInput.value = data.message;
      editModal.classList.remove('hidden');
      editMessageInput.focus();
    }

    document.getElementById('save-edit-btn').addEventListener('click', () => {
      const newMessage = editMessageInput.value.trim();
      if (newMessage && editingMessageId) {
        socket.emit('editMessage', { id: editingMessageId, newMessage }, (response) => {
          if (response.success) {
            editModal.classList.add('hidden');
            editingMessageId = null;
          } else {
            alert(response.error);
          }
        });
      }
    });

    document.getElementById('cancel-edit-btn').addEventListener('click', () => {
      editModal.classList.add('hidden');
      editingMessageId = null;
    });

    function addPrivateMessageToHistory(data, myUsername) {
      const isSent = data.from === myUsername;
      const pmDiv = document.createElement('div');
      pmDiv.className = 'message-container' + (isSent ? ' own-message' : '');
      pmDiv.dataset.id = data.id;

      if (isSent) {
        pmDiv.style.backgroundColor = '#e6f0ff';
        pmDiv.style.borderLeft = '4px solid #3498db';
        pmDiv.innerHTML = `
          <div class="message-name" style="color: #3498db">🔒 ${escapeHtml(data.to)} へのプライベートメッセージ</div>
          <div class="message-text">${escapeHtml(data.message)}</div>
          <div class="message-meta">
            <span class="message-time">${formatTime(data.timestamp)}</span>
            ${data.edited ? '<span class="edited-mark">(編集済み)</span>' : ''}
          </div>
          ${isPrivilegedAdmin ? '<button class="action-menu-btn">⋮</button>' : ''}
        `;
      } else {
        pmDiv.style.backgroundColor = '#ffe6f0';
        pmDiv.style.borderLeft = '4px solid #e91e63';
        pmDiv.innerHTML = `
          <div class="message-name" style="color: ${data.color || '#e91e63'}">🔒 ${escapeHtml(data.from)} からのプライベートメッセージ</div>
          <div class="message-text">${escapeHtml(data.message)}</div>
          <div class="message-meta">
            <span class="message-time">${formatTime(data.timestamp)}</span>
            ${data.edited ? '<span class="edited-mark">(編集済み)</span>' : ''}
          </div>
          ${isPrivilegedAdmin ? '<button class="action-menu-btn">⋮</button>' : ''}
        `;
      }

      if (isPrivilegedAdmin) {
        const menuBtn = pmDiv.querySelector('.action-menu-btn');
        if (menuBtn) {
          menuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            togglePMActionMenu(data, pmDiv);
          });
        }
      }

      chatBox.appendChild(pmDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function addMonitoredPrivateMessageToHistory(data) {
      const pmDiv = document.createElement('div');
      pmDiv.className = 'message-container';
      pmDiv.dataset.id = data.id;
      pmDiv.style.backgroundColor = '#fff3e0';
      pmDiv.style.borderLeft = '4px solid #ff9800';
      pmDiv.innerHTML = `
        <div class="message-name" style="color: #ff9800">👁️ プライベートメッセージ監視: ${escapeHtml(data.from)} → ${escapeHtml(data.to)}</div>
        <div class="message-text">${escapeHtml(data.message)}</div>
        <div class="message-meta">
          <span class="message-time">${formatTime(data.timestamp)}</span>
          ${data.edited ? '<span class="edited-mark">(編集済み)</span>' : ''}
        </div>
        ${isPrivilegedAdmin ? '<button class="action-menu-btn">⋮</button>' : ''}
      `;
      
      if (isPrivilegedAdmin) {
        const menuBtn = pmDiv.querySelector('.action-menu-btn');
        menuBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          togglePMActionMenu(data, pmDiv);
        });
      }
      
      chatBox.appendChild(pmDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function addSystemMessage(text) {
      const div = document.createElement('div');
      div.className = 'system-message';
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function updateUserList(users) {
      userCount.textContent = `${users.length}人`;
      userNames.textContent = users.join(', ');
    }

    document.getElementById('updateProfileButton').addEventListener('click', () => {
      const data = {
        color: document.getElementById('nameColor').value,
        statusText: document.getElementById('statusText').value.trim(),
        theme: themeSelect.value
      };

      socket.emit('updateAccountProfile', data, (response) => {
        if (response.success) {
          currentProfile = { ...currentProfile, ...response.account };
          applyTheme(response.account.theme);
          userStatusMap[currentUser] = response.account.statusText;
          alert('プロフィールを更新しました');
        } else {
          alert(response.error || '更新に失敗しました');
        }
      });
    });

    themeSelect.addEventListener('change', () => {
      applyTheme(themeSelect.value);
    });

    document.getElementById('logoutButton').addEventListener('click', () => {
      if (confirm('ログアウトしますか？')) {
        const token = localStorage.getItem('chatToken');
        socket.emit('accountLogout', { token });
        stopHeartbeat();
        localStorage.removeItem('chatToken');
        localStorage.removeItem('chatDisplayName');
        window.location.reload();
      }
    });

    socket.on('message', (data) => {
      addMessage(data);
    });

    socket.on('messageEdited', (data) => {
      const container = document.querySelector(`.message-container[data-id="${data.id}"]`);
      if (container) {
        const textEl = container.querySelector('.message-text');
        const metaEl = container.querySelector('.message-meta');
        textEl.innerHTML = escapeHtml(data.message).replace(/\n/g, '<br>');
        if (!metaEl.querySelector('.edited-mark')) {
          metaEl.innerHTML += '<span class="edited-mark">(編集済み)</span>';
        }
      }
    });

    socket.on('messageDeleted', ({ id }) => {
      const container = document.querySelector(`.message-container[data-id="${id}"]`);
      if (container) {
        container.remove();
      }
    });

    socket.on('allMessagesDeleted', () => {
      chatBox.innerHTML = '';
      addSystemMessage('管理者がすべてのメッセージを削除しました');
    });

    socket.on('systemMessage', (text) => {
      addSystemMessage(text);
    });

    socket.on('userJoined', (data) => {
      addSystemMessage(`${data.username} がチャットに参加しました`);
      updateUserList(data.users);
    });

    socket.on('userLeft', (data) => {
      addSystemMessage(`${data.username} がチャットから退出しました`);
      updateUserList(data.users);
    });

    socket.on('userListUpdate', (users) => {
      updateUserList(users);
    });

    socket.on('adminStatus', (data) => {
      if (data.isAdmin) {
        const adminIndicator = document.getElementById('admin-indicator');
        const ipList = document.getElementById('user-ip-list');
        const ipHistory = document.getElementById('user-ip-history');
        
        if (adminIndicator) adminIndicator.classList.remove('hidden');
        if (ipList) ipList.classList.remove('hidden');
        if (ipHistory) ipHistory.classList.remove('hidden');
      }
    });

    socket.on('userIpList', (userIpList) => {
      const ipListContainer = document.getElementById('user-ip-list');
      const ipListContent = document.getElementById('ip-list-content');
      
      if (isPrivilegedAdmin && userIpList && userIpList.length > 0) {
        ipListContainer.classList.remove('hidden');
        ipListContent.innerHTML = userIpList.map(item => `
          <div class="ip-list-item">
            <span class="ip-list-username">${escapeHtml(item.username)}</span>
            <span class="ip-list-ip">${escapeHtml(item.ip)}</span>
          </div>
        `).join('');
      } else if (!isPrivilegedAdmin) {
        ipListContainer.classList.add('hidden');
      } else {
        ipListContent.innerHTML = '<div style="color: #888; font-size: 12px;">オンラインユーザーなし</div>';
      }
    });

    let allUserIpHistory = [];

    function renderIpHistory(itemsToRender) {
      const historyContent = document.getElementById('ip-history-content');
      if (!historyContent) return;
      
      if (itemsToRender && itemsToRender.length > 0) {
        historyContent.innerHTML = itemsToRender.map(item => `
          <div class="ip-history-item">
            <span class="ip-history-username">${escapeHtml(item.displayName)}</span>
            <span class="ip-history-ip">${escapeHtml(item.ipAddress)}</span>
            <span class="ip-history-time">最終: ${formatTime(item.lastSeen)}</span>
          </div>
        `).join('');
      } else {
        historyContent.innerHTML = '<div style="color: #888; font-size: 12px; padding: 10px; text-align: center;">該当する履歴がありません</div>';
      }
    }

    function updateUserIpHistory(userIpHistory) {
      const historyContainer = document.getElementById('user-ip-history');
      if (!historyContainer) return;
      
      if (!isPrivilegedAdmin) {
        historyContainer.classList.add('hidden');
        return;
      }
      
      if (userIpHistory) {
        allUserIpHistory = userIpHistory;
        historyContainer.classList.remove('hidden');
        renderIpHistory(userIpHistory);
        
        // Set up search functionality
        const searchInput = document.getElementById('ip-history-search');
        if (searchInput && !searchInput.dataset.listenerAttached) {
          searchInput.dataset.listenerAttached = 'true';
          searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            socket.emit('getIpHistory', query);
          });
        }
      }
    }

    socket.on('userIpHistory', (userIpHistory) => {
      updateUserIpHistory(userIpHistory);
    });

    socket.on('userStatusUpdate', (data) => {
      userStatusMap[data.username] = data.statusText;
    });

    socket.on('privateMessage', (data) => {
      const pmDiv = document.createElement('div');
      pmDiv.className = 'message-container';
      pmDiv.dataset.id = data.id;
      pmDiv.style.backgroundColor = '#ffe6f0';
      pmDiv.style.borderLeft = '4px solid #e91e63';
      pmDiv.innerHTML = `
        <div class="message-name" style="color: ${data.color || '#e91e63'}">🔒 ${escapeHtml(data.from)} からのプライベートメッセージ</div>
        <div class="message-text">${escapeHtml(data.message)}</div>
        <div class="message-meta">
          <span class="message-time">${formatTime(data.timestamp)}</span>
        </div>
        ${isPrivilegedAdmin ? '<button class="action-menu-btn">⋮</button>' : ''}
      `;
      
      if (isPrivilegedAdmin) {
        const menuBtn = pmDiv.querySelector('.action-menu-btn');
        if (menuBtn) {
          menuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            togglePMActionMenu(data, pmDiv);
          });
        }
      }
      
      chatBox.appendChild(pmDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on('privateMessageSent', (data) => {
      const pmDiv = document.createElement('div');
      pmDiv.className = 'message-container own-message';
      pmDiv.dataset.id = data.id;
      pmDiv.style.backgroundColor = '#e6f0ff';
      pmDiv.style.borderLeft = '4px solid #3498db';
      pmDiv.innerHTML = `
        <div class="message-name" style="color: #3498db">🔒 ${escapeHtml(data.to)} へのプライベートメッセージ</div>
        <div class="message-text">${escapeHtml(data.message)}</div>
        <div class="message-meta">
          <span class="message-time">${formatTime(data.timestamp)}</span>
        </div>
        ${isPrivilegedAdmin ? '<button class="action-menu-btn">⋮</button>' : ''}
      `;
      
      if (isPrivilegedAdmin) {
        const menuBtn = pmDiv.querySelector('.action-menu-btn');
        if (menuBtn) {
          menuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            togglePMActionMenu(data, pmDiv);
          });
        }
      }
      
      chatBox.appendChild(pmDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on('privateMessageMonitor', (data) => {
      const pmDiv = document.createElement('div');
      pmDiv.className = 'message-container';
      pmDiv.dataset.id = data.id;
      pmDiv.style.backgroundColor = '#fff3e0';
      pmDiv.style.borderLeft = '4px solid #ff9800';
      pmDiv.innerHTML = `
        <div class="message-name" style="color: #ff9800">👁️ プライベートメッセージ監視: ${escapeHtml(data.from)} → ${escapeHtml(data.to)}</div>
        <div class="message-text">${escapeHtml(data.message)}</div>
        <div class="message-meta">
          <span class="message-time">${formatTime(data.timestamp)}</span>
          ${data.edited ? '<span class="edited-mark">(編集済み)</span>' : ''}
        </div>
        ${isPrivilegedAdmin ? '<button class="action-menu-btn">⋮</button>' : ''}
      `;
      
      if (isPrivilegedAdmin) {
        const menuBtn = pmDiv.querySelector('.action-menu-btn');
        menuBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          togglePMActionMenu(data, pmDiv);
        });
      }
      
      chatBox.appendChild(pmDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    });
    
    function togglePMActionMenu(data, container) {
      const existingMenu = document.querySelector('.action-menu');
      if (existingMenu) {
        existingMenu.remove();
        if (openMenuId === data.id) {
          openMenuId = null;
          return;
        }
      }

      openMenuId = data.id;
      const menu = document.createElement('div');
      menu.className = 'action-menu';
      menu.innerHTML = `
        <div class="edit-action">編集</div>
        <div class="delete-action delete">削除</div>
      `;

      menu.querySelector('.edit-action').addEventListener('click', () => {
        openEditModal(data);
        menu.remove();
        openMenuId = null;
      });

      menu.querySelector('.delete-action').addEventListener('click', () => {
        if (confirm('このプライベートメッセージを削除しますか？')) {
          socket.emit('deleteMessage', { id: data.id }, (response) => {
            if (!response.success) {
              alert(response.error);
            }
          });
        }
        menu.remove();
        openMenuId = null;
      });

      container.appendChild(menu);
    }

    socket.on('privateMessageEdited', (data) => {
      const container = document.querySelector(`.message-container[data-id="${data.id}"]`);
      if (container) {
        const textEl = container.querySelector('.message-text');
        if (textEl) {
          textEl.textContent = data.message;
        }
        const metaEl = container.querySelector('.message-meta');
        if (metaEl && !metaEl.querySelector('.edited-mark')) {
          metaEl.insertAdjacentHTML('beforeend', '<span class="edited-mark">(編集済み)</span>');
        }
      }
    });

    socket.on('privateMessageDeleted', (data) => {
      const container = document.querySelector(`.message-container[data-id="${data.id}"]`);
      if (container) {
        container.remove();
      }
    });

    socket.on('banned', (data) => {
      alert(data.message);
      stopHeartbeat();
      currentUser = null;
      currentProfile = null;
      localStorage.removeItem('chatToken');
      localStorage.removeItem('chatDisplayName');
      chatSection.classList.add('hidden');
      authSection.classList.remove('hidden');
      chatBox.innerHTML = '';
      document.body.className = 'theme-default';
    });

    socket.on('userTyping', (username) => {
      typingIndicator.textContent = `${username} が入力中...`;
      typingIndicator.classList.remove('hidden');
    });

    socket.on('userStopTyping', () => {
      typingIndicator.classList.add('hidden');
    });

    socket.on('profileUpdated', (data) => {
      if (data.color) {
        currentProfile.color = data.color;
        document.getElementById('nameColor').value = data.color;
      }
    });

    socket.on('server-ping', () => {
      socket.emit('heartbeat');
    });

    socket.on('heartbeat-ack', () => {});

    socket.on('connect', () => {
      console.log('Connected to server');
      const token = localStorage.getItem('chatToken');
      if (currentUser && token) {
        socket.emit('tokenLogin', { token }, (response) => {
          if (response && response.success) {
            addSystemMessage('サーバーに再接続しました');
            isAdmin = response.account.isAdmin;
            isPrivilegedAdmin = PRIVILEGED_ADMIN_USERS.includes(currentUser);
            if (isAdmin) {
              document.getElementById('admin-indicator').classList.remove('hidden');
            }
            if (isPrivilegedAdmin) {
              document.getElementById('user-ip-list').classList.remove('hidden');
              document.getElementById('user-ip-history').classList.remove('hidden');
            }
            chatBox.innerHTML = '';
            
            if (isPrivilegedAdmin && response.allPrivateMessages && response.allPrivateMessages.length > 0) {
              const allMessages = [];
              if (response.history && response.history.length > 0) {
                response.history.forEach(msg => {
                  allMessages.push({ type: 'regular', data: msg, timestamp: new Date(msg.timestamp).getTime() });
                });
              }
              response.allPrivateMessages.forEach(pm => {
                allMessages.push({ type: 'pm_monitor', data: pm, timestamp: new Date(pm.timestamp).getTime() });
              });
              allMessages.sort((a, b) => a.timestamp - b.timestamp);
              allMessages.forEach(item => {
                if (item.type === 'regular') {
                  addMessage(item.data);
                } else {
                  addMonitoredPrivateMessageToHistory(item.data);
                }
              });
            } else {
              if (response.history && response.history.length > 0) {
                response.history.forEach(msg => addMessage(msg));
              }
              if (response.privateMessageHistory && response.privateMessageHistory.length > 0) {
                response.privateMessageHistory.forEach(pm => addPrivateMessageToHistory(pm, currentUser));
              }
            }
            
            if (response.userStatuses) {
              userStatusMap = response.userStatuses;
            }
            if (isPrivilegedAdmin && response.userIpHistory) {
              updateUserIpHistory(response.userIpHistory);
            }
            updateUserList(response.onlineUsers || []);
            startHeartbeat();
          } else {
            localStorage.removeItem('chatToken');
            localStorage.removeItem('chatDisplayName');
            window.location.reload();
          }
        });
      }
    });

    socket.on('disconnect', (reason) => {
      console.log('Disconnected from server:', reason);
      stopHeartbeat();
      if (currentUser) {
        addSystemMessage('サーバーとの接続が切断されました。再接続中...');
      }
    });

    socket.on('reconnect', (attemptNumber) => {
      console.log(`Reconnected after ${attemptNumber} attempts`);
    });

    socket.on('reconnect_failed', () => {
      addSystemMessage('再接続に失敗しました。ページをリロードしてください。');
    });

    socket.on('connect_error', (error) => {
      console.log('Connection error:', error.message);
    });
  </script>
</body>
</html>
